generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GuildConfig {
  id                String   @id @default(cuid())
  guildId           String   @unique
  categoryId        String?
  instructionsChannelId String?

  // Channel IDs for each language
  englishChannelId    String?
  spanishChannelId    String?
  portugueseChannelId String?
  frenchChannelId     String?
  germanChannelId     String?
  italianChannelId    String?
  japaneseChannelId   String?
  koreanChannelId     String?
  chineseChannelId    String?

  // Webhook IDs for each language channel
  englishWebhookId      String?
  englishWebhookToken   String?
  spanishWebhookId      String?
  spanishWebhookToken   String?
  portugueseWebhookId   String?
  portugueseWebhookToken String?
  frenchWebhookId       String?
  frenchWebhookToken    String?
  germanWebhookId       String?
  germanWebhookToken    String?
  italianWebhookId      String?
  italianWebhookToken   String?
  japaneseWebhookId     String?
  japaneseWebhookToken  String?
  koreanWebhookId       String?
  koreanWebhookToken    String?
  chineseWebhookId      String?
  chineseWebhookToken   String?

  // Moderation settings
  modLogChannelId       String?

  // Language settings - JSON array of enabled language codes, empty = all enabled
  enabledLanguages      String   @default("[]")
  disabledCategoryId    String?  // Category for disabled language channels

  // Permission settings
  useCustomPermissions  Boolean @default(false)

  // Usage tracking
  monthlyCharacterUsage Int      @default(0)
  usageResetDate        DateTime @default(now())

  // Subscription
  subscriptionTier      String   @default("free") // free, pro, premium
  subscriptionExpiresAt DateTime?
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verifiedUsers        VerifiedUser[]
  usageLogs            UsageLog[]
  commandPermissions   CommandPermission[]
}

model VerifiedUser {
  id              String   @id @default(cuid())
  discordId       String
  guildId         String
  username        String
  discriminator   String?
  avatar          String?

  // Usage tracking per user
  monthlyCharacterUsage Int      @default(0)
  usageResetDate        DateTime @default(now())

  // Streak tracking
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActiveDate   DateTime?
  totalTranslations Int     @default(0)

  // Achievements (stored as JSON array of achievement IDs)
  achievements     String   @default("[]")

  // Language subscriptions - JSON array of codes, empty = all languages
  subscribedLanguages   String   @default("[]")

  // Display preferences
  displayMode           String   @default("detailed")  // "detailed" | "compact"

  // Privacy
  showOnLeaderboard     Boolean  @default(true)

  // Immersion access toggle - allows users to opt out while remaining verified
  immersionEnabled      Boolean  @default(true)

  verifiedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Link to global user (optional for backwards compatibility)
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  guildConfig GuildConfig @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  usageLogs   UsageLog[]

  @@unique([discordId, guildId])
  @@index([discordId])
  @@index([guildId])
  @@index([userId])
}

model UsageLog {
  id            String   @id @default(cuid())
  guildId       String
  userId        String
  sourceLanguage String
  targetLanguage String
  characterCount Int

  createdAt DateTime @default(now())

  guildConfig  GuildConfig  @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  verifiedUser VerifiedUser @relation(fields: [userId, guildId], references: [discordId, guildId], onDelete: Cascade)

  @@index([guildId])
  @@index([userId])
  @@index([createdAt])
}

model Session {
  sid    String   @id @db.VarChar(255)
  sess   Json
  expire DateTime @db.Timestamptz

  @@map("session")
}

// Immersion ban/timeout tracking
model ImmersionBan {
  id        String   @id @default(cuid())
  guildId   String
  discordId String   // The banned user

  // Ban details
  reason    String?
  bannedBy  String   // Moderator who issued the ban
  bannedAt  DateTime @default(now())
  expiresAt DateTime? // null = permanent

  // Status
  active    Boolean  @default(true)

  // If unbanned early
  unbannedBy String?
  unbannedAt DateTime?
  unbanReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([discordId, guildId, active]) // Only one active ban per user per guild
  @@index([guildId])
  @@index([discordId])
  @@index([expiresAt])
  @@index([active])
}

// Moderation action log for audit trail
model ModerationLog {
  id        String   @id @default(cuid())
  guildId   String
  targetId  String   // User who was moderated
  moderatorId String // User who performed the action

  // Action details
  action    String   // "ban", "unban", "timeout", "warn", "clear_warnings"
  reason    String?
  duration  Int?     // Duration in seconds (for timeouts)
  metadata  String?  // JSON for additional data

  createdAt DateTime @default(now())

  @@index([guildId])
  @@index([targetId])
  @@index([moderatorId])
  @@index([createdAt])
}

// Warning system
model ImmersionWarning {
  id        String   @id @default(cuid())
  guildId   String
  discordId String   // The warned user

  // Warning details
  reason    String
  warnedBy  String   // Moderator who issued the warning

  // Status
  active    Boolean  @default(true)

  createdAt DateTime @default(now())

  @@index([guildId])
  @@index([discordId])
  @@index([active])
}

// Global user model for personal subscriptions (separate from per-guild VerifiedUser)
model User {
  id        String  @id @default(cuid())
  discordId String  @unique
  username  String
  avatar    String?

  // Personal subscription (independent of any server)
  subscriptionTier      String    @default("free") // free, pro, premium
  subscriptionExpiresAt DateTime?
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  // Global stats (aggregated across all servers)
  totalTranslationsAllTime Int @default(0)
  totalCharactersAllTime   Int @default(0)

  // Native language for UI
  nativeLanguage          String?

  // Notification preferences (JSON)
  notificationPrefs       String   @default("{\"achievements\":true,\"streaks\":true}")

  // Master DM toggle
  dmNotificationsEnabled  Boolean  @default(true)

  // Bot developer flag
  isBotDeveloper          Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verifiedUsers VerifiedUser[]
}

// Persistent usage tracker - survives guild config resets to prevent abuse
model GuildUsageTracker {
  id                    String   @id @default(cuid())
  guildId               String   @unique

  // Usage tracking (persists across resets)
  monthlyCharacterUsage Int      @default(0)
  usageResetDate        DateTime @default(now())

  // Reset abuse prevention
  lastResetAt           DateTime?
  resetCount            Int      @default(0) // Total resets this month
  resetCountResetDate   DateTime @default(now()) // When to reset the reset count

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Command permission overrides for guild admins
model CommandPermission {
  id           String   @id @default(cuid())
  guildId      String
  commandGroup String   // "mod" | "mod.ban" | "immersion.setup" etc.
  roleId       String?  // Discord role ID
  userId       String?  // Discord user ID
  permission   String   @default("allow")  // "allow" | "deny"
  createdAt    DateTime @default(now())
  createdBy    String   // Admin who created this

  guildConfig  GuildConfig @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, commandGroup, roleId])
  @@unique([guildId, commandGroup, userId])
  @@index([guildId])
}

// Bot developer audit log for tracking administrative actions
model DeveloperAuditLog {
  id          String   @id @default(cuid())
  developerId String
  action      String   // "announcement", "subscription_update", etc.
  targetType  String   // "guild", "user", "global"
  targetId    String?
  details     String   // JSON string with additional details
  createdAt   DateTime @default(now())

  @@index([developerId])
  @@index([createdAt])
}

// Announcement system for bot developers
model Announcement {
  id          String    @id @default(cuid())
  developerId String
  type        String    // "server_owners", "all_servers", "verified_users"
  title       String
  content     String
  status      String    @default("pending") // pending, sending, completed, failed
  targetCount Int       @default(0)
  sentCount   Int       @default(0)
  failedCount Int       @default(0)
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([status])
}
